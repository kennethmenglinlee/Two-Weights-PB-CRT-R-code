---
title: "Simulation"
output: html_document
date: "2024-03-22"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r * sim P-CRT data}
library(dplyr)
library(lme4)
library(WeMix)

set.seed(2525)

# SET PB-CRT design 
I=26 # cluster
# I=10
# J=2 # 2 periods
# n=100 # average clusterperiod sizes

# SET treatment effect
trtmnteffectL = 0.2
trtmnteffectH = 0.5 # 0.2, 0.5

# SET random effect sequences
ICC = 0.05
sigma2e = 1
tau2a = ICC*sigma2e/(1-ICC)
tau2a

# SET period effects
# period <- 0.2

# generate output dataset
saves <- c(
  paste0(rep(c("IEE", "IEEw"), each=1), c("_est")),
  paste0(rep(c("EME", "EMEw"), each=1), c("_est"))
)
saves
sim.df <- data.frame(matrix(ncol=length(saves), nrow=0))
names(sim.df) <- saves # rename columns
sim.df

# generate n_sims
n_sims <- 100

ptm <- proc.time()
for(n in 1:n_sims){
  
  ####### generate cluster:period cell means data ####### 
  
  # generate alpha
  I
  alpha <- rnorm(n=I, mean=0, sd=sqrt(tau2a))
  alpha
  # alpha.mat <- matrix(rep(alpha, J), nrow=I, ncol=J)
  alpha.mat <- matrix(alpha, nrow=I)
  # alpha.mat
  # generate gamma
  # gamma <- rnorm(n=I*J, mean=0, sd=tau2g)
  # gamma.mat <- matrix(gamma, nrow=I, ncol=J)
  # gamma.mat
  
  # generate period effects
  # period.mat <- matrix(c(rep(1, I), rep(1+period, I)), nrow=I, ncol=J)
  # period.mat
  
  # randomly generate random treatment
  trtmnteffect.mat <- matrix(
    # rep(c(rep(trtmnteffectL,I/2), rep(trtmnteffectH,I/2)), J),
    c(rep(trtmnteffectL,I/2), rep(trtmnteffectH,I/2)),
    nrow=I #,
    # ncol=J
  )
  trtmnteffect.mat
  subpopulation.mat <- ifelse(trtmnteffect.mat==trtmnteffectL,"L", ifelse(trtmnteffect.mat==trtmnteffectH,"H",0))
  subpopulation.mat
  
  # randomly select clusters that will receive intervention 
  z <- sample(c(rep(0,I/2),rep(1,I/2)), I)
  # z <- c(rep(0,I), z)
  z
  # z.mat <- matrix(z, nrow=I, ncol=J) # add baseline and make into matrix
  z.mat <- matrix(z, nrow=I)
  z.mat
  # check
  c(z.mat) == z
  
  # generate outcomes matrix
  ztrtmnt.mat <- z.mat * trtmnteffect.mat
  ztrtmnt.mat
  # # UATE with superpopulation
  # (trtmnteffectL + trtmnteffectH) / 2
  # # UATE with finite population
  # sum(ztrtmnt.mat) / (I/2)
  
  # sum up everything
  alpha.mat
  # gamma.mat
  # period.mat
  ztrtmnt.mat
  # outcomes.mat <- alpha.mat + gamma.mat + period.mat + ztrtmnt.mat
  outcomes.mat <- alpha.mat + ztrtmnt.mat
  outcomes.mat
  
  # generate df
  means.df <- data.frame(
    # cluster = rep(1:I, 2),
    cluster = rep(1:I),
    # period = rep(c(0,1), each=I),
    z = c(z.mat),
    avgoutcomes = c(outcomes.mat),
    subpopulation = c(subpopulation.mat)
  )
  means.df
  
  
  # generate different cluster:period sizes
  n_cpL <- rpois(I/2, 20) # variable cluster sizes and equal cp sizes
  n_cpH <- rpois(I/2, 100) # variable cluster sizes and equal cp sizes
  n_cpL
  n_cpH
  n_cp <- c(n_cpL, n_cpH)
  # n_cp2 <- rep(n_cp, 2)
  # table(n_cp2, c(subpopulation.mat)) # check
  table(n_cp, c(subpopulation.mat)) # check
  
  # replicate cluster:period mean entries by corresponding cluster size
  means.df$Freq <- n_cp
  # pb.df2 <- as.data.frame(lapply(means.df, rep, n_cp2))
  # pb.df2
  p.df2 <- as.data.frame(lapply(means.df, rep, n_cp))
  
  # generate outcomes 
  # pb.df2$outcome <- pb.df2$avgoutcomes + rnorm(n=nrow(pb.df2), mean=0, sd=sigma2e)
  p.df2$outcome <- p.df2$avgoutcomes + rnorm(n=nrow(p.df2), mean=0, sd=sigma2e)
  
  # # create weighted df
  # clusterperiodsize <- as.data.frame(table(p.df2$cluster, p.df2$period))
  # colnames(clusterperiodsize) <- c("cluster", "period", "Freq")
  # clusterperiodsize
  # pb.df2weighted <- merge(pb.df2, clusterperiodsize, by=c("cluster","period"))
  p.df2$W1 <- 1/p.df2$Freq
  
  # # create cluster:period wieghts
  # pb.df2weighted %>% str()
  # pb.df2weighted$clusterperiod <- paste(pb.df2weighted$cluster, pb.df2weighted$period, sep="_")
  
  # prepare df for analysis
  p.df2$cluster <- as.factor(p.df2$cluster)
  # pb.df2$period <- as.factor(pb.df2$period)
  p.df2$intervention <- p.df2$z
  
  # analyses
  IEE <- lm(outcome ~ intervention, data = p.df2)
  # summary(IEE)$coef[,"Estimate"]["intervention"]
  # summary(IEE)$coef[,"Std. Error"]["intervention"]^2
  # clubSandwich::vcovCR(IEE, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"]
  
  IEEw <- lm(outcome ~ intervention, data = p.df2, weights = p.df2$W1)
  # summary(IEEw)$coef[,"Estimate"]["intervention"]
  # summary(IEEw)$coef[,"Std. Error"]["intervention"]^2
  # clubSandwich::vcovCR(IEEw, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"]
  
  # FE <- lm(outcome ~ intervention + period-1 + cluster, data = pb.df2weighted)
  # summary(FE)$coef[,"Estimate"]["intervention"]
  # summary(FE)$coef[,"Std. Error"]["intervention"]^2
  # clubSandwich::vcovCR(FE, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"]
  
  # FEw <- lm(outcome ~ intervention + period-1 + cluster, data = pb.df2weighted, weights = 1/pb.df2weighted$Freq)
  # summary(FEw)$coef[,"Estimate"]["intervention"]
  # summary(FEw)$coef[,"Std. Error"]["intervention"]^2
  # clubSandwich::vcovCR(FEw, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"]
  
  EME <- lme4::lmer(outcome ~ intervention + (1|cluster), data = p.df2)
  # summary(EME)$coef[,"Estimate"]["intervention"]
  # summary(EME)$coef[,"Std. Error"]["intervention"]^2
  
  EMEw <- mix(outcome ~ intervention + (1|cluster), data=p.df2, weights=c("W1", "W1"))
  # summary(EMEw)$coef[,"Estimate"]["intervention"]
  # summary(EMEw)$coef[,"Std. Error"]["intervention"]^2 
  
  # NEME <- lme4::lmer(outcome ~ intervention + period-1 + (1|cluster) + (1|cluster:period), data = pb.df2weighted)
  # summary(NEME)$coef[,"Estimate"]["intervention"]
  # summary(NEME)$coef[,"Std. Error"]["intervention"]^2
  
  # NEMEw <- mix(outcome ~ intervention + period-1 + (1|cluster) + (1|cluster:period), data=pb.df2weighted, weights=c("W1", "W1", "W1"))
  # summary(NEMEw)$coef[,"Estimate"]["intervention"]
  # summary(NEMEw)$coef[,"Std. Error"]["intervention"]^2
  
  sim.df <- sim.df %>% 
    add_row(
      IEE_est = summary(IEE)$coef[,"Estimate"]["intervention"],
      # IEE_var = summary(IEE)$coef[,"Std. Error"]["intervention"]^2,
      # IEE_CR2 = clubSandwich::vcovCR(IEE, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"],
      IEEw_est = summary(IEEw)$coef[,"Estimate"]["intervention"],
      # IEEw_var = summary(IEEw)$coef[,"Std. Error"]["intervention"]^2,
      # IEEw_CR2 = clubSandwich::vcovCR(IEEw, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"],
      # FE_est = summary(FE)$coef[,"Estimate"]["intervention"],
      # FE_var = summary(FE)$coef[,"Std. Error"]["intervention"]^2,
      # FE_CR2 = clubSandwich::vcovCR(FE, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"],
      # FEw_est = summary(FEw)$coef[,"Estimate"]["intervention"],
      # FEw_var = summary(FEw)$coef[,"Std. Error"]["intervention"]^2,
      # FEw_CR2 = clubSandwich::vcovCR(FEw, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"],
      EME_est = summary(EME)$coef[,"Estimate"]["intervention"],
      # EME_var = summary(EME)$coef[,"Std. Error"]["intervention"]^2,
      EMEw_est = summary(EMEw)$coef[,"Estimate"]["intervention"]#,
      # EMEw_var = summary(EMEw)$coef[,"Std. Error"]["intervention"]^2 ,
      # NEME_est = summary(NEME)$coef[,"Estimate"]["intervention"],
      # NEME_var = summary(NEME)$coef[,"Std. Error"]["intervention"]^2,
      # NEMEw_est = summary(NEMEw)$coef[,"Estimate"]["intervention"],
      # NEMEw_var = summary(NEMEw)$coef[,"Std. Error"]["intervention"]^2
    )
  
  print(nrow(sim.df))
}
etm <- proc.time()-ptm 
etm
# 40 minutes for 1000 sim

sim.df

# cATE with superpopulation
cATE <- (trtmnteffectL + trtmnteffectH) / 2
# # cATE with finite population
# sum(ztrtmnt.mat) / (I/2)

# weighted analyses [not estimating the right estimand]
(mean(sim.df$IEE_est) - cATE)/cATE
# (mean(sim.df$FE_est) - cATE)/cATE
(mean(sim.df$EME_est) - cATE)/cATE
# (mean(sim.df$NEME_est) - cATE)/cATE

# weighted analyses [estimating the "right" estimand]
(mean(sim.df$IEEw_est) - cATE)/cATE # -0.01228072 (1000 nsims)
# (mean(sim.df$FEw_est) - cATE)/cATE
(mean(sim.df$EMEw_est) - cATE)/cATE # -0.2358962 (1000 nsims)
# (mean(sim.df$NEMEw_est) - cATE)/cATE
# EMEw is more biased as demonstrated in Xueqi's article
```


# Independence
# Exchangeable
# Nested Exchangeable
```{r * sim PB-CRT data}
library(dplyr)
library(lme4)
library(WeMix)

set.seed(2525)
hetTrtmnt = T

# set.seed(1583)
# hetTrtmnt = F


# SET PB-CRT design 
# I=26 # cluster
# I=20
I=10
J=2 # 2 periods

# SET treatment effect
if(hetTrtmnt == T){
  trtmnteffectL = 0.2
  trtmnteffectH = 0.5 # 0.2, 0.5
}else{
  trtmnteffectL = 0.35
  trtmnteffectH = 0.35
}

# SET random effect sequences
ICC = 0.05
CAC = 0.8 # As defined in Ouyang tau2a/(tau2a + tau2g) 
sigma2e = 1
tau2a = ICC*sigma2e/(1-ICC)
tau2a
tau2g = tau2a*(1-CAC)/CAC # fixed CAC following the definition in Ouyang
tau2g

# SET period effects
period <- 0.2

# generate output dataset
saves <- c(
  paste0(rep(c("IEE", "IEEw", "FE", "FEw"), each=4), c("_est", "_var", "_var_CR2", "_var_jk")),
  paste0(rep(c("EME", "EMEw", "NEME", "NEMEw"), each=3), c("_est", "_var", "_var_jk"))
)
saves
sim.df <- data.frame(matrix(ncol=length(saves), nrow=0))
names(sim.df) <- saves # rename columns
sim.df

# generate jackknife saves
saves_jk <- c("cluster_i","IEE", "IEEw", "FE", "FEw","EME", "EMEw", "NEME", "NEMEw")

# generate n_sims
n_sims <- 1000

ptm <- proc.time()
for(n in 1:n_sims){
  
  ####### generate cluster:period cell means data ####### 
  
  # generate alpha
  I
  alpha <- rnorm(n=I, mean=0, sd=sqrt(tau2a))
  alpha
  alpha.mat <- matrix(rep(alpha, J), nrow=I, ncol=J)
  alpha.mat
  # generate gamma
  gamma <- rnorm(n=I*J, mean=0, sd=sqrt(tau2g))
  gamma.mat <- matrix(gamma, nrow=I, ncol=J)
  gamma.mat
  
  # generate period effects
  period.mat <- matrix(c(rep(1, I), rep(1+period, I)), nrow=I, ncol=J)
  period.mat
  
  # randomly generate random treatment
  trtmnteffect.mat <- matrix(
    rep(c(rep(trtmnteffectL,I/2), rep(trtmnteffectH,I/2)), J),
    nrow=I,
    ncol=J
  )
  trtmnteffect.mat
  subpopulation.mat <- ifelse(trtmnteffect.mat==trtmnteffectL,"L", ifelse(trtmnteffect.mat==trtmnteffectH,"H",0))
  subpopulation.mat
  
  # randomly select clusters that will receive intervention 
  z <- sample(c(rep(0,I/2),rep(1,I/2)), I)
  z <- c(rep(0,I), z)
  z
  z.mat <- matrix(z, nrow=I, ncol=J) # add baseline and make into matrix
  z.mat
  # check
  c(z.mat) == z
  
  # generate outcomes matrix
  ztrtmnt.mat <- z.mat * trtmnteffect.mat
  ztrtmnt.mat
  # # UATE with superpopulation
  # (trtmnteffectL + trtmnteffectH) / 2
  # # UATE with finite population
  # sum(ztrtmnt.mat) / (I/2)
  
  # sum up everything
  alpha.mat
  gamma.mat
  period.mat
  ztrtmnt.mat
  outcomes.mat <- alpha.mat + gamma.mat + period.mat + ztrtmnt.mat
  outcomes.mat
  
  # generate df
  means.df <- data.frame(
    cluster = rep(1:I, 2),
    period = rep(c(0,1), each=I),
    z = c(z.mat),
    avgoutcomes = c(outcomes.mat),
    subpopulation = c(subpopulation.mat)
  )
  means.df
  
  
  # generate different cluster:period sizes
  n_cpL <- rpois(I/2, 20) # variable cluster sizes and equal cp sizes
  n_cpH <- rpois(I/2, 100) # variable cluster sizes and equal cp sizes
  n_cpL
  n_cpH
  n_cp <- c(n_cpL, n_cpH)
  n_cp2 <- rep(n_cp, 2)
  table(n_cp2, c(subpopulation.mat)) # check
  
  # replicate cluster:period mean entries by corresponding cluster size
  means.df
    means.df$Freq <- n_cp2
  pb.df2 <- as.data.frame(lapply(means.df, rep, n_cp2))
  pb.df2
  
  # generate outcomes 
  pb.df2$outcome <- pb.df2$avgoutcomes + rnorm(n=nrow(pb.df2), mean=0, sd=sigma2e)
  
  # # create weighted df
    pb.df2weighted <- pb.df2
  # clusterperiodsize <- as.data.frame(table(pb.df2$cluster, pb.df2$period))
  # colnames(clusterperiodsize) <- c("cluster", "period", "Freq")
  # clusterperiodsize
  # pb.df2weighted <- merge(pb.df2, clusterperiodsize, by=c("cluster","period"))
  pb.df2weighted$W1 <- 1/pb.df2weighted$Freq
  
  # # create cluster:period wieghts
  # pb.df2weighted %>% str()
  # pb.df2weighted$clusterperiod <- paste(pb.df2weighted$cluster, pb.df2weighted$period, sep="_")
  
  # prepare df for analysis
  pb.df2weighted$cluster <- as.factor(pb.df2weighted$cluster)
  # pb.df2$period <- as.factor(pb.df2$period)
  pb.df2weighted$intervention <- pb.df2weighted$z
  
  # analyses
  IEE <- lm(outcome ~ intervention + period-1, data = pb.df2weighted)
  # summary(IEE)$coef[,"Estimate"]["intervention"]
  # summary(IEE)$coef[,"Std. Error"]["intervention"]^2
  # clubSandwich::vcovCR(IEE, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"]
  
  IEEw <- lm(outcome ~ intervention + period-1, data = pb.df2weighted, weights = pb.df2weighted$W1)
  # summary(IEEw)$coef[,"Estimate"]["intervention"]
  # summary(IEEw)$coef[,"Std. Error"]["intervention"]^2
  # clubSandwich::vcovCR(IEEw, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"]
  
  FE <- lm(outcome ~ intervention + period-1 + cluster, data = pb.df2weighted)
  # summary(FE)$coef[,"Estimate"]["intervention"]
  # summary(FE)$coef[,"Std. Error"]["intervention"]^2
  # clubSandwich::vcovCR(FE, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"]
  
  FEw <- lm(outcome ~ intervention + period-1 + cluster, data = pb.df2weighted, weights = pb.df2weighted$W1)
  # summary(FEw)$coef[,"Estimate"]["intervention"]
  # summary(FEw)$coef[,"Std. Error"]["intervention"]^2
  # clubSandwich::vcovCR(FEw, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"]
  
  EME <- lme4::lmer(outcome ~ intervention + period-1 + (1|cluster), data = pb.df2weighted)
  # summary(EME)$coef[,"Estimate"]["intervention"]
  # summary(EME)$coef[,"Std. Error"]["intervention"]^2
  
  EMEw <- mix(outcome ~ intervention + period-1 + (1|cluster), data=pb.df2weighted, weights=c("W1", "W1"))
  # summary(EMEw)$coef[,"Estimate"]["intervention"]
  # summary(EMEw)$coef[,"Std. Error"]["intervention"]^2 
  
  NEME <- lme4::lmer(outcome ~ intervention + period-1 + (1|cluster) + (1|cluster:period), data = pb.df2weighted)
  # summary(NEME)$coef[,"Estimate"]["intervention"]
  # summary(NEME)$coef[,"Std. Error"]["intervention"]^2
  
  # outputs an error?
  NEMEw <- mix(outcome ~ intervention + period-1 + (1|cluster) + (1|cluster:period), data=pb.df2weighted, weights=c("W1", "W1", "W1"))
  # summary(NEMEw)$coef[,"Estimate"]["intervention"]
  # summary(NEMEw)$coef[,"Std. Error"]["intervention"]^2
  
  # Jackknife
  jk.df <- data.frame(matrix(ncol=length(saves_jk), nrow=0))
  names(jk.df) <- saves_jk
  jk.df
  # jk.estimates <- c()
  for(i in levels(pb.df2weighted$cluster)){
    jk.dat <- pb.df2weighted %>% filter(cluster!=i)
    # jk.estimates <- c(jk.estimates, 
    #                   summary(lme4::lmer(outcome ~ intervention + time-1 + (1|cluster), data = jk.dat)
    #                   )$coef[,"Estimate"]["intervention"]
    # )
    jk.df <- jk.df %>%
      add_row(
        cluster_i=as.numeric(i),
        IEE = summary(lm(outcome ~ intervention + period-1, data = jk.dat))$coef[,"Estimate"]["intervention"],
        IEEw = summary(lm(outcome ~ intervention + period-1, data = jk.dat, weights = jk.dat$W1))$coef[,"Estimate"]["intervention"],
        FE = summary(lm(outcome ~ intervention + period-1 + cluster, data = jk.dat))$coef[,"Estimate"]["intervention"],
        FEw = summary(lm(outcome ~ intervention + period-1 + cluster, data = jk.dat, weights = jk.dat$W1))$coef[,"Estimate"]["intervention"],
        EME = summary(lme4::lmer(outcome ~ intervention + period-1 + (1|cluster), data = jk.dat))$coef[,"Estimate"]["intervention"],
        EMEw = summary(mix(outcome ~ intervention + period-1 + (1|cluster), data=jk.dat, weights=c("W1", "W1")))$coef[,"Estimate"]["intervention"],
        NEME = summary(lme4::lmer(outcome ~ intervention + period-1 + (1|cluster) + (1|cluster:period), data = jk.dat))$coef[,"Estimate"]["intervention"],
        NEMEw = summary(mix(outcome ~ intervention + period-1 + (1|cluster) + (1|cluster:period), data=jk.dat, weights=c("W1", "W1", "W1")))$coef[,"Estimate"]["intervention"]
      )
    print(paste0(nrow(sim.df),".",i))
  }
  jk.df

  sim.df <- sim.df %>% 
    add_row(
      IEE_est = summary(IEE)$coef[,"Estimate"]["intervention"],
      IEE_var = summary(IEE)$coef[,"Std. Error"]["intervention"]^2,
      IEE_var_CR2 = clubSandwich::vcovCR(IEE, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"],
      IEE_var_jk = sum((jk.df$IEE-summary(IEE)$coef[,"Estimate"]["intervention"])^2)*(nrow(jk.df)-1)/(nrow(jk.df)),
      IEEw_est = summary(IEEw)$coef[,"Estimate"]["intervention"],
      IEEw_var = summary(IEEw)$coef[,"Std. Error"]["intervention"]^2,
      IEEw_var_CR2 = clubSandwich::vcovCR(IEEw, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"],
      IEEw_var_jk = sum((jk.df$IEEw-summary(IEEw)$coef[,"Estimate"]["intervention"])^2)*(nrow(jk.df)-1)/(nrow(jk.df)),
      
      FE_est = summary(FE)$coef[,"Estimate"]["intervention"],
      FE_var = summary(FE)$coef[,"Std. Error"]["intervention"]^2,
      FE_var_CR2 = clubSandwich::vcovCR(FE, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"],
      FE_var_jk = sum((jk.df$FE-summary(FE)$coef[,"Estimate"]["intervention"])^2)*(nrow(jk.df)-1)/(nrow(jk.df)),
      
      FEw_est = summary(FEw)$coef[,"Estimate"]["intervention"],
      FEw_var = summary(FEw)$coef[,"Std. Error"]["intervention"]^2,
      FEw_var_CR2 = clubSandwich::vcovCR(FEw, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"],
      FEw_var_jk = sum((jk.df$FEw-summary(FEw)$coef[,"Estimate"]["intervention"])^2)*(nrow(jk.df)-1)/(nrow(jk.df)),
      
      EME_est = summary(EME)$coef[,"Estimate"]["intervention"],
      EME_var = summary(EME)$coef[,"Std. Error"]["intervention"]^2,
      EME_var_jk = sum((jk.df$EME-summary(EME)$coef[,"Estimate"]["intervention"])^2)*(nrow(jk.df)-1)/(nrow(jk.df)),
      EMEw_est = summary(EMEw)$coef[,"Estimate"]["intervention"],
      EMEw_var = summary(EMEw)$coef[,"Std. Error"]["intervention"]^2 ,
      EMEw_var_jk = sum((jk.df$EMEw-summary(EMEw)$coef[,"Estimate"]["intervention"])^2)*(nrow(jk.df)-1)/(nrow(jk.df)),
      
      NEME_est = summary(NEME)$coef[,"Estimate"]["intervention"],
      NEME_var = summary(NEME)$coef[,"Std. Error"]["intervention"]^2,
      NEME_var_jk = sum((jk.df$NEME-summary(NEME)$coef[,"Estimate"]["intervention"])^2)*(nrow(jk.df)-1)/(nrow(jk.df)),
      
      NEMEw_est = summary(NEMEw)$coef[,"Estimate"]["intervention"],
      NEMEw_var = summary(NEMEw)$coef[,"Std. Error"]["intervention"]^2,
      NEMEw_var_jk = sum((jk.df$NEMEw-summary(NEMEw)$coef[,"Estimate"]["intervention"])^2)*(nrow(jk.df)-1)/(nrow(jk.df))
    )
  
  print(nrow(sim.df))
}
etm <- proc.time()-ptm 
etm
# 40 minutes for 1000 sim
# write.csv(sim.df, "1000nsim_PB_NEX.csv")

sim.df

# cATE with superpopulation
cATE <- (trtmnteffectL + trtmnteffectH) / 2
# # cATE with finite population
# sum(ztrtmnt.mat) / (I/2)

# weighted analyses [not estimating the right estimand]
(mean(sim.df$IEE_est) - cATE)/cATE
(mean(sim.df$FE_est) - cATE)/cATE
(mean(sim.df$EME_est) - cATE)/cATE
(mean(sim.df$NEME_est) - cATE)/cATE

# weighted analyses [estimating the "right" estimand]
(mean(sim.df$IEEw_est) - cATE)/cATE # -0.01000265 (1000 sims, CAC=0.2)
(mean(sim.df$FEw_est) - cATE)/cATE # 0.00204578 (1000 sims, CAC=0.2)
(mean(sim.df$EMEw_est) - cATE)/cATE # -0.001779746 (1000 sims, CAC=0.2)
(mean(sim.df$NEMEw_est) - cATE)/cATE # -0.1222478 (1000 sims, CAC=0.2)
# EMEw is strangely not that biased...?

sim.df
write.csv(sim.df, paste0("results_",n_sims,"sim_",hetTrtmnt,"hettrtmnt_",CAC,"CAC_",ICC,"ICC",".csv"))
# write.csv(sim.df, paste(n_sims,"sim_results_with_jackknife.csv"))
# write.csv(sim.df, paste(n_sims,"sim_results_with_jackknife.csv"))
```
What should I do about "boundary (singular) fit: see help('isSingular')"?
Simulating this with 26 clusters and a jackknife, with all the analyses (especially the weighted ME analyses, takes forever.)

[26 clusters] 1155.95 seconds (~ 20 minutes) for 10 nsims
~ 200 minutes (~ 3.3 hrs) for 100 nsims (might be sufficient)
~ 33 hrs for 1000 nsims (Xueqi did 1000 nsims)
-> To speed up: Maybe can cut the # of clusters in the sim 
-> To speed up: Maybe not do jackknife for all analyses (just do it for ME?), CR2 is close to jackknife for IEE & FE

[10 clusters] 224.38 seconds(~3.75 minutes) for 10 nsims
~ 30.75 minutes for 100 sims
~ 307.5 minutes (~ 5 hrs) for 1000 nsims
-> Solution: Just cut the # of clusters. Look at case studies.

[20 clusters (Costantini et al. 2014 (Hooper et al. 2018))] 760 seconds (~12 minutes) for 10 nsims
~ 126.66 minutes (2.11 hrs) for 100 sims
~ 21 hrs for 1000 nsims
-> Plan: Simulate with 10 clusters first, then try with 20 clusters if necessary.

```{r * clean analysis df w/ informative cluster sizes}
library(dplyr)

n_sims = 1000
# sim.df <- read.csv(paste(n_sims,"sim_results_with_jackknife.csv"))

# sim.df <- read.csv("results_1000sim_TRUEhettrtmnt_0.8CAC_0.05ICC.csv")
sim.df <- read.csv("results_1000sim_FALSEhettrtmnt_0.8CAC_0.05ICC.csv")

head(sim.df)
colnames(sim.df)

# trtmnteffectL = 0.2
# trtmnteffectH = 0.5 # 0.2, 0.5

cate <- (0.2+0.5)/2

# generate Bias
bias.df <- sim.df[grepl("est",colnames(sim.df))] - cate
relbias.df <- (bias.df/cate)*100

# generate CI
sim.df[grepl("est",colnames(sim.df))]
CI.df <- sim.df %>%
  mutate(
    # IEE
    IEE_mod_95_H = IEE_est + 1.96*sqrt(IEE_var),
    IEE_mod_95_L = IEE_est - 1.96*sqrt(IEE_var),
    IEE_CR2_95_H = IEE_est + 1.96*sqrt(IEE_var_CR2),
    IEE_CR2_95_L = IEE_est - 1.96*sqrt(IEE_var_CR2),
    IEE_jk_95_H = IEE_est + 1.96*sqrt(IEE_var_jk),
    IEE_jk_95_L = IEE_est - 1.96*sqrt(IEE_var_jk),
    # IEEw
    IEEw_mod_95_H = IEEw_est + 1.96*sqrt(IEEw_var),
    IEEw_mod_95_L = IEEw_est - 1.96*sqrt(IEEw_var),
    IEEw_CR2_95_H = IEEw_est + 1.96*sqrt(IEEw_var_CR2),
    IEEw_CR2_95_L = IEEw_est - 1.96*sqrt(IEEw_var_CR2),
    IEEw_jk_95_H = IEEw_est + 1.96*sqrt(IEEw_var_jk),
    IEEw_jk_95_L = IEEw_est - 1.96*sqrt(IEEw_var_jk),
    # FE
    FE_mod_95_H = FE_est + 1.96*sqrt(FE_var),
    FE_mod_95_L = FE_est - 1.96*sqrt(FE_var),
    FE_CR2_95_H = FE_est + 1.96*sqrt(FE_var_CR2),
    FE_CR2_95_L = FE_est - 1.96*sqrt(FE_var_CR2),
    FE_jk_95_H = FE_est + 1.96*sqrt(FE_var_jk),
    FE_jk_95_L = FE_est - 1.96*sqrt(FE_var_jk),
    # FEw
    FEw_mod_95_H = FEw_est + 1.96*sqrt(FEw_var),
    FEw_mod_95_L = FEw_est - 1.96*sqrt(FEw_var),
    FEw_CR2_95_H = FEw_est + 1.96*sqrt(FEw_var_CR2),
    FEw_CR2_95_L = FEw_est - 1.96*sqrt(FEw_var_CR2),
    FEw_jk_95_H = FEw_est + 1.96*sqrt(FEw_var_jk),
    FEw_jk_95_L = FEw_est - 1.96*sqrt(FEw_var_jk),
    # EME
    EME_mod_95_H = EME_est + 1.96*sqrt(EME_var),
    EME_mod_95_L = EME_est - 1.96*sqrt(EME_var),
    EME_jk_95_H = EME_est + 1.96*sqrt(EME_var_jk),
    EME_jk_95_L = EME_est - 1.96*sqrt(EME_var_jk),
    # EMEw
    EMEw_mod_95_H = EMEw_est + 1.96*sqrt(EMEw_var),
    EMEw_mod_95_L = EMEw_est - 1.96*sqrt(EMEw_var),
    EMEw_jk_95_H = EMEw_est + 1.96*sqrt(EMEw_var_jk),
    EMEw_jk_95_L = EMEw_est - 1.96*sqrt(EMEw_var_jk),
    # NEME
    NEME_mod_95_H = NEME_est + 1.96*sqrt(NEME_var),
    NEME_mod_95_L = NEME_est - 1.96*sqrt(NEME_var),
    NEME_jk_95_H = NEME_est + 1.96*sqrt(NEME_var_jk),
    NEME_jk_95_L = NEME_est - 1.96*sqrt(NEME_var_jk),
    # NEMEw
    NEMEw_mod_95_H = NEMEw_est + 1.96*sqrt(NEMEw_var),
    NEMEw_mod_95_L = NEMEw_est - 1.96*sqrt(NEMEw_var),
    NEMEw_jk_95_H = NEMEw_est + 1.96*sqrt(NEMEw_var_jk),
    NEMEw_jk_95_L = NEMEw_est - 1.96*sqrt(NEMEw_var_jk),
    ) %>%
  select(
    colnames(.[grepl("95",colnames(.))])
  )
# generate CP
CP.df <- CI.df %>%   
  mutate(
    # IEE
    IEE_mod_CP = ifelse(cate > IEE_mod_95_L & cate < IEE_mod_95_H, 1, 0),
    IEE_CR2_CP = ifelse(cate > IEE_CR2_95_L & cate < IEE_CR2_95_H, 1, 0),
    IEE_jk_CP = ifelse(cate > IEE_jk_95_L & cate < IEE_jk_95_H, 1, 0),
    # IEEw
    IEEw_mod_CP = ifelse(cate > IEEw_mod_95_L & cate < IEEw_mod_95_H, 1, 0),
    IEEw_CR2_CP = ifelse(cate > IEEw_CR2_95_L & cate < IEEw_CR2_95_H, 1, 0),
    IEEw_jk_CP = ifelse(cate > IEEw_jk_95_L & cate < IEEw_jk_95_H, 1, 0),
    # FE
    FE_mod_CP = ifelse(cate > FE_mod_95_L & cate < FE_mod_95_H, 1, 0),
    FE_CR2_CP = ifelse(cate > FE_CR2_95_L & cate < FE_CR2_95_H, 1, 0),
    FE_jk_CP = ifelse(cate > FE_jk_95_L & cate < FE_jk_95_H, 1, 0),
    # FEw
    FEw_mod_CP = ifelse(cate > FEw_mod_95_L & cate < FEw_mod_95_H, 1, 0),
    FEw_CR2_CP = ifelse(cate > FEw_CR2_95_L & cate < FEw_CR2_95_H, 1, 0),
    FEw_jk_CP = ifelse(cate > FEw_jk_95_L & cate < FEw_jk_95_H, 1, 0),
    # EME
    EME_mod_CP = ifelse(cate > EME_mod_95_L & cate < EME_mod_95_H, 1, 0),
    EME_jk_CP = ifelse(cate > EME_jk_95_L & cate < EME_jk_95_H, 1, 0),
    # EMEw
    EMEw_mod_CP = ifelse(cate > EMEw_mod_95_L & cate < EMEw_mod_95_H, 1, 0),
    EMEw_jk_CP = ifelse(cate > EMEw_jk_95_L & cate < EMEw_jk_95_H, 1, 0),
    # NEME
    NEME_mod_CP = ifelse(cate > NEME_mod_95_L & cate < NEME_mod_95_H, 1, 0),
    NEME_jk_CP = ifelse(cate > NEME_jk_95_L & cate < NEME_jk_95_H, 1, 0),
    # NEMEw
    NEMEw_mod_CP = ifelse(cate > NEMEw_mod_95_L & cate < NEMEw_mod_95_H, 1, 0),
    NEMEw_jk_CP = ifelse(cate > NEMEw_jk_95_L & cate < NEMEw_jk_95_H, 1, 0)
  ) %>%
  select(
    colnames(.[grepl("CP",colnames(.))])
  )
# generate Power
power.df <- CI.df %>%   
  mutate(
    # IEE
    IEE_mod_power = ifelse(0 > IEE_mod_95_L & 0 < IEE_mod_95_H, 0, 1),
    IEE_CR2_power = ifelse(0 > IEE_CR2_95_L & 0 < IEE_CR2_95_H, 0, 1),
    IEE_jk_power = ifelse(0 > IEE_jk_95_L & 0 < IEE_jk_95_H, 0, 1),
    # IEEw
    IEEw_mod_power = ifelse(0 > IEEw_mod_95_L & 0 < IEEw_mod_95_H, 0, 1),
    IEEw_CR2_power = ifelse(0 > IEEw_CR2_95_L & 0 < IEEw_CR2_95_H, 0, 1),
    IEEw_jk_power = ifelse(0 > IEEw_jk_95_L & 0 < IEEw_jk_95_H, 0, 1),
    # FE
    FE_mod_power = ifelse(0 > FE_mod_95_L & 0 < FE_mod_95_H, 0, 1),
    FE_CR2_power = ifelse(0 > FE_CR2_95_L & 0 < FE_CR2_95_H, 0, 1),
    FE_jk_power = ifelse(0 > FE_jk_95_L & 0 < FE_jk_95_H, 0, 1),
    # FEw
    FEw_mod_power = ifelse(0 > FEw_mod_95_L & 0 < FEw_mod_95_H, 0, 1),
    FEw_CR2_power = ifelse(0 > FEw_CR2_95_L & 0 < FEw_CR2_95_H, 0, 1),
    FEw_jk_power = ifelse(0 > FEw_jk_95_L & 0 < FEw_jk_95_H, 0, 1),
    # EME
    EME_mod_power = ifelse(0 > EME_mod_95_L & 0 < EME_mod_95_H, 0, 1),
    EME_jk_power = ifelse(0 > EME_jk_95_L & 0 < EME_jk_95_H, 0, 1),
    # EMEw
    EMEw_mod_power = ifelse(0 > EMEw_mod_95_L & 0 < EMEw_mod_95_H, 0, 1),
    EMEw_jk_power = ifelse(0 > EMEw_jk_95_L & 0 < EMEw_jk_95_H, 0, 1),
    # NEME
    NEME_mod_power = ifelse(0 > NEME_mod_95_L & 0 < NEME_mod_95_H, 0, 1),
    NEME_jk_power = ifelse(0 > NEME_jk_95_L & 0 < NEME_jk_95_H, 0, 1),
    # NEMEw
    NEMEw_mod_power = ifelse(0 > NEMEw_mod_95_L & 0 < NEMEw_mod_95_H, 0, 1),
    NEMEw_jk_power = ifelse(0 > NEMEw_jk_95_L & 0 < NEMEw_jk_95_H, 0, 1)
  ) %>%
  select(
    colnames(.[grepl("power",colnames(.))])
  )
# generate RMSE
MSE.df <- (sim.df[grepl("est",colnames(sim.df))] - cate)^2

# bias results  
results.relbias <- colMeans(relbias.df)
# not much a surprise that non-weighted are biased, they're estimating the wrong thing
# relbias.df %>%
#   select(
#     colnames(.[grepl("w",colnames(.))])
#   ) %>%
#   colMeans()
# # this is what we're mostly interested in

# CP results
results.CP <- colMeans(CP.df)

# Power results
results.power <- colMeans(power.df)

# RMSE results
results.RMSE <- sqrt(colMeans(MSE.df))

results.relbias
results.CP
results.power
results.RMSE

# check average variance results against MCSE

```

```{r * Plot results}
library(ggplot2)

# plot relative bias and RMSE results
# combine rel bias and RMSE results
rbind(
  results.relbias %>% 
    reshape2::melt() %>% 
    mutate(
      analysis = sub("\\_.*", "", rownames(.)), # only keep analysis title (up to "_")
      result = "Relative Bias (%)",
      weighted = ifelse(grepl("w",analysis),"Weighted","Unweighted")
    )
  ,
  results.RMSE %>% 
    reshape2::melt() %>% 
    mutate(
      analysis = sub("\\_.*", "", rownames(.)),
      result = "RMSE",
      weighted = ifelse(grepl("w",analysis),"Weighted","Unweighted")
    )
) %>%
  # factor
  mutate(analysis = factor(analysis, levels=c("IEE","FE","EME","NEME","IEEw","FEw","EMEw","NEMEw"))) %>%
  # plot
  ggplot(., aes(x=analysis, y=value, color=I("black"))) + 
  # ggplot(., aes(x=analysis, y=value, fill=analysis)) + 
  geom_bar(stat = "identity") +
  facet_grid(result~weighted, scales="free") +
    geom_hline(data = data.frame(result = c("Relative Bias (%)","Relative Bias (%)", "RMSE"), hline = c(5, -5, NA)), aes(yintercept = hline), linetype = "dashed") +
  # scale_fill_manual(values = rep(c("green4", "blue4", "purple3", "red2"),2) ) +
  labs(y=NULL, x=NULL, title = "Relative Bias & RMSE") +
  theme_bw() +
  theme(legend.position = "none")
# width: 500, height: 300

# plot CP, precision, power results
# combine rel bias and RMSE results
rbind(
  results.CP %>% 
    reshape2::melt() %>% 
    mutate(
      analysis = sub("\\_.*", "", rownames(.)), # only keep analysis title (up to "_")
      varianceestimator = sub(".+_(.+)","\\1", sub("\\_CP.*", "", names(results.CP))), # annoying but works
      result = "CP",
      weighted = ifelse(grepl("w",analysis),"Weighted","Unweighted")
    )
  ,
  results.power %>% 
    reshape2::melt() %>% 
    mutate(
      analysis = sub("\\_.*", "", rownames(.)), # only keep analysis title (up to "_")
      varianceestimator = sub(".+_(.+)","\\1", sub("\\_CP.*", "", names(results.CP))), # annoying but works
      result = "Power",
      weighted = ifelse(grepl("w",analysis),"Weighted","Unweighted")
    )
) %>%
  filter(varianceestimator != "CR2") %>% # remove CR2 variance estimators
  mutate(varianceestimator = ifelse(varianceestimator=="mod","Model","Jackknife")) %>% # rename variance estimator levels
  # factor
  mutate(
    analysis = factor(analysis, levels=c("IEE","FE","EME","NEME","IEEw","FEw","EMEw","NEMEw")),
    # analysis = factor(analysis, levels=c("IEE","IEEw","FE","FEw","EME","EMEw","NEME","NEMEw")),
    varianceestimator = factor(varianceestimator, levels=c("Model","Jackknife"))
    ) %>%
  # plot
  # ggplot(., aes(x=varianceestimator, y=value, fill=analysis)) +
  ggplot(., aes(x=analysis, y=value, fill=varianceestimator, color=varianceestimator)) +
  geom_bar(position="dodge", stat = "identity") +
  facet_grid(result~weighted, scales="free_x") +
  geom_hline(data = data.frame(result = c("CP", "Power"), hline = c(0.95, NA)), aes(yintercept = hline), linetype = "dashed") +
  scale_fill_manual(values=c("gray","gray2")) +
    scale_color_manual(values=c("black","black")) +
  # scale_fill_manual(values = rep(c("green4", "blue4", "purple3", "red2"), each=2) ) +
  labs(y=NULL, x=NULL, title = "Coverage Probability & Power", fill="Variance Estimator", color="Variance Estimator") +
  theme_bw() +
  theme(legend.position = "bottom")
# width: 500, height: 400
```

```{r * Variance plots}
colMeans(sim.df[grepl("var",colnames(sim.df))])
results.MCSE <- sapply(sim.df[grepl("est",colnames(sim.df))], var)
names(results.MCSE) <- paste0(names(results.MCSE),"_var_MC")
results.variance <- c(results.MCSE, colMeans(sim.df[grepl("var",colnames(sim.df))])) %>% reshape2::melt()

results.variance %>% 
  mutate(
    analysis = sub("\\_.*", "", rownames(.)), # only keep analysis title (up to "_")
    varianceestimator = sub(".+_(.+)","\\1", rownames(results.variance)),
    # result = "Power",
    weighted = ifelse(grepl("w",analysis),"Weighted","Unweighted")
  ) %>%
  filter(varianceestimator != "CR2") %>%
  mutate(varianceestimator = ifelse(varianceestimator=="var", "Model", ifelse(varianceestimator=="jk", "Jackknife", "Monte Carlo"))) %>%
  mutate(
    varianceestimator = factor(varianceestimator, levels=c("Model","Jackknife","Monte Carlo")),
    analysis = factor(analysis, levels=c("IEE","FE","EME","NEME","IEEw","FEw","EMEw","NEMEw"))
  ) %>%
  # plot
  ggplot(., aes(x=analysis, y=value, fill=varianceestimator, color=varianceestimator)) +
  geom_bar(position="dodge", stat = "identity") +
  facet_grid(~weighted, scales="free_x") +
  scale_fill_manual(values=c("gray","gray2","white")) +
  scale_color_manual(values=c("black","black","black")) +
  # scale_fill_manual(values = rep(c("green4", "blue4", "purple3", "red2"), each=2) ) +
  labs(y="Variance", x=NULL, fill="Variance Estimator", color="Variance Estimator") +
  theme_bw() +
  theme(legend.position = "bottom")
# width: 500, height: 300
``` 

```{r * Supplementary Results CR2}
results.variance %>% 
  mutate(
    analysis = sub("\\_.*", "", rownames(.)), # only keep analysis title (up to "_")
    varianceestimator = sub(".+_(.+)","\\1", rownames(results.variance)),
    # result = "Power",
    weighted = ifelse(grepl("w",analysis),"Weighted","Unweighted")
  ) %>%
  # filter(varianceestimator != "CR2") %>%
  mutate(varianceestimator = ifelse(varianceestimator=="var", "Model", ifelse(varianceestimator=="jk", "Jackknife", ifelse(varianceestimator=="MC","Monte Carlo","BRL")))) %>%
  filter(!(analysis %in% c("EME","NEME","EMEw","NEMEw"))) %>%
  mutate(
    varianceestimator = factor(varianceestimator, levels=c("Model","Jackknife","BRL","Monte Carlo")),
    # analysis = factor(analysis, levels=c("IEE","FE","EME","NEME","IEEw","FEw","EMEw","NEMEw"))
    analysis = factor(analysis, levels=c("IEE","FE","IEEw","FEw"))
  ) %>%
  # plot
  ggplot(., aes(x=analysis, y=value, fill=varianceestimator, color=varianceestimator)) +
  geom_bar(position="dodge", stat = "identity") +
  facet_grid(~weighted, scales="free_x") +
  scale_fill_manual(values=c("gray","gray2","gray25","white")) +
  scale_color_manual(values=c("black","black","black","black")) +
  # scale_fill_manual(values = rep(c("green4", "blue4", "purple3", "red2"), each=2) ) +
  labs(y="Variance", x=NULL, fill="Variance Estimator", color="Variance Estimator") +
  theme_bw() +
  theme(legend.position = "bottom")
# width: 500, height: 300

# plot CP, precision, power results
# combine rel bias and RMSE results
rbind(
  results.CP %>% 
    reshape2::melt() %>% 
    mutate(
      analysis = sub("\\_.*", "", rownames(.)), # only keep analysis title (up to "_")
      varianceestimator = sub(".+_(.+)","\\1", sub("\\_CP.*", "", names(results.CP))), # annoying but works
      result = "CP",
      weighted = ifelse(grepl("w",analysis),"Weighted","Unweighted")
    )
  ,
  results.power %>% 
    reshape2::melt() %>% 
    mutate(
      analysis = sub("\\_.*", "", rownames(.)), # only keep analysis title (up to "_")
      varianceestimator = sub(".+_(.+)","\\1", sub("\\_CP.*", "", names(results.CP))), # annoying but works
      result = "Power",
      weighted = ifelse(grepl("w",analysis),"Weighted","Unweighted")
    )
) %>%
  # filter(varianceestimator != "CR2") %>% # remove CR2 variance estimators
  # mutate(varianceestimator = ifelse(varianceestimator=="mod","Model","Jackknife")) %>% # rename variance estimator levels
  mutate(varianceestimator = ifelse(varianceestimator=="mod", "Model", ifelse(varianceestimator=="jk", "Jackknife", ifelse(varianceestimator=="MC","Monte Carlo","BRL")))) %>%
  filter(!(analysis %in% c("EME","NEME","EMEw","NEMEw"))) %>%
  # factor
  mutate(
    analysis = factor(analysis, levels=c("IEE","FE","IEEw","FEw")),
    # analysis = factor(analysis, levels=c("IEE","FE","EME","NEME","IEEw","FEw","EMEw","NEMEw")),
    # analysis = factor(analysis, levels=c("IEE","IEEw","FE","FEw","EME","EMEw","NEME","NEMEw")),
    varianceestimator = factor(varianceestimator, levels=c("Model","Jackknife","BRL"))
    ) %>%
  # plot
  # ggplot(., aes(x=varianceestimator, y=value, fill=analysis)) +
  ggplot(., aes(x=analysis, y=value, fill=varianceestimator, color=varianceestimator)) +
  geom_bar(position="dodge", stat = "identity") +
  facet_grid(result~weighted, scales="free_x") +
  geom_hline(data = data.frame(result = c("CP", "Power"), hline = c(0.95, NA)), aes(yintercept = hline), linetype = "dashed") +
  scale_fill_manual(values=c("gray","gray2","gray25")) +
    scale_color_manual(values=c("black","black","black")) +
  # scale_fill_manual(values = rep(c("green4", "blue4", "purple3", "red2"), each=2) ) +
  labs(y=NULL, x=NULL, title = "Coverage Probability & Power", fill="Variance Estimator", color="Variance Estimator") +
  theme_bw() +
  theme(legend.position = "bottom")
# width: 500, height: 400
```


```{r Test Inference}
# analysis
library(lmer)
library(WeMix)
library(clubSandwich)

# https://cran.r-project.org/web/packages/clubSandwich/vignettes/panel-data-CRVE.html

# https://cran.r-project.org/web/packages/clubSandwich/clubSandwich.pdf

# vcovCR: "CR2" is the "bias-reduced linearization" adjustment proposed by Bell and McCaffrey (2002) and further developed in Pustejovsky and Tipton (2017). The adjustment is chosen so that the variance-covariance estimator is exactly unbiased under a user-specified working model.

# IEE
IEE <- lm(outcome ~ intervention + time-1, data = pb.df2weighted)
summary(IEE)$coef[,"Estimate"]["intervention"]
summary(IEE)$coef[,"Std. Error"]["intervention"]^2
clubSandwich::vcovCR(IEE, cluster = pb.df2weighted$cluster, type = "CR0")["intervention","intervention"]
clubSandwich::vcovCR(IEE, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"]
# clubSandwich::vcovCR(IEE, cluster = pb.df2weighted$clusterperiod, type = "CR2")["intervention","intervention"]
clubSandwich::vcovCR(IEE, cluster = pb.df2weighted$cluster, type = "CR3")["intervention","intervention"]
clubSandwich::coef_test(IEE, vcov = "CR2",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,]
clubSandwich::coef_test(IEE, vcov = "CR3",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,]

# IEEw
IEEw <- lm(outcome ~ intervention + time-1, data = pb.df2weighted, weights = pb.df2weighted$W1)
summary(IEEw)$coef[,"Estimate"]["intervention"]
summary(IEEw)$coef[,"Std. Error"]["intervention"]^2
clubSandwich::vcovCR(IEEw, cluster = pb.df2weighted$cluster, type = "CR0")["intervention","intervention"]
clubSandwich::vcovCR(IEEw, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"]
# clubSandwich::vcovCR(IEEw, cluster = pb.df2weighted$clusterperiod, type = "CR2")["intervention","intervention"]
clubSandwich::vcovCR(IEEw, cluster = pb.df2weighted$cluster, type = "CR3")["intervention","intervention"]
clubSandwich::coef_test(IEEw, vcov = "CR2",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,]
clubSandwich::coef_test(IEEw, vcov = "CR3",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,]
# # /from the clubSandwich vignette: Even with weights, the coef_test function uses an “independent, homoskedastic” working model as a default for lm objects. In the present example, the outcome is a standardized rate and so a better assumption might be that the error variances are inversely proportional to population size. The following code uses this alternate working model:
# clubSandwich::coef_test(IEEw, vcov = "CR2",  cluster = pb.df2weighted$cluster, target = 1 / pb.df2weighted$W1, test = "Satterthwaite")[1,]
# # ^ I don't totally understand this, using error variances that are inversely proportional to weights... I reckon that kind of defeats the purpose because we're trying to estimate UATE.

# FE
FE <- lm(outcome ~ intervention + time-1 + cluster, data = pb.df2weighted)
summary(FE)$coef[,"Estimate"]["intervention"]
summary(FE)$coef[,"Std. Error"]["intervention"]^2
clubSandwich::vcovCR(FE, cluster = pb.df2weighted$cluster, type = "CR0")["intervention","intervention"]
clubSandwich::vcovCR(FE, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"]
# clubSandwich::vcovCR(FE, cluster = pb.df2weighted$clusterperiod, type = "CR2")["intervention","intervention"]
# clubSandwich::vcovCR(FE, cluster = pb.df2weighted$cluster, type = "CR3")["intervention","intervention"]
clubSandwich::coef_test(FE, vcov = "CR2",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,]
# clubSandwich::coef_test(FE, vcov = "CR3",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,]

# some strange errors with clubSandwich with FE & FEw

# FEw
FEw <- lm(outcome ~ intervention + time-1 + cluster, data = pb.df2weighted, weights = 1/pb.df2weighted$Freq)
summary(FEw)$coef[,"Estimate"]["intervention"]
summary(FEw)$coef[,"Std. Error"]["intervention"]^2
clubSandwich::vcovCR(FEw, cluster = pb.df2weighted$cluster, type = "CR0")["intervention","intervention"]
clubSandwich::vcovCR(FEw, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"]
clubSandwich::vcovCR(FEw, cluster = pb.df2weighted$clusterperiod, type = "CR2")["intervention","intervention"]
clubSandwich::vcovCR(FEw, cluster = pb.df2weighted$cluster, type = "CR3")["intervention","intervention"]
clubSandwich::coef_test(FEw, vcov = "CR2",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,]
# clubSandwich::coef_test(FEw, vcov = "CR3",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,]

# EME
EME <- lme4::lmer(outcome ~ intervention + time-1 + (1|cluster), data = pb.df2weighted)
summary(EME)$coef[,"Estimate"]["intervention"]
summary(EME)$coef[,"Std. Error"]["intervention"]^2
clubSandwich::vcovCR(EME, cluster = pb.df2weighted$cluster, type = "CR1")["intervention","intervention"]
clubSandwich::vcovCR(EME, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"]
# clubSandwich::vcovCR(EME, cluster = pb.df2weighted$clusterperiod, type = "CR2")["intervention","intervention"]
clubSandwich::vcovCR(EME, cluster = pb.df2weighted$cluster, type = "CR3")["intervention","intervention"]
clubSandwich::coef_test(EME, vcov = "CR2",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,]
clubSandwich::coef_test(EME, vcov = "CR3",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,]

# EMEw
EMEw <- mix(outcome ~ intervention + time-1 + (1|cluster), data=pb.df2weighted, weights=c("W1", "W1"))
summary(EMEw)$coef[,"Estimate"]["intervention"]
summary(EMEw)$coef[,"Std. Error"]["intervention"]^2 
EMEw$SE^2 # uses CR0 standard errors (no small sample size correction)
# clubSandwich::vcovCR(EMEw, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"]
# clubSandwich::vcovCR(EMEw, cluster = pb.df2weighted$clusterperiod, type = "CR2")["intervention","intervention"]
clubSandwich::coef_test(EMEw, vcov = "CR2",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,]
clubSandwich::coef_test(EMEw, vcov = "CR3",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,]

# NEME
NEME <- lme4::lmer(outcome ~ intervention + time-1 + (1|cluster) + (1|cluster:period), data = pb.df2weighted)
summary(NEME)$coef[,"Estimate"]["intervention"]
summary(NEME)$coef[,"Std. Error"]["intervention"]^2
clubSandwich::vcovCR(NEME, cluster = pb.df2weighted$cluster, type = "CR1")["intervention","intervention"]
clubSandwich::vcovCR(NEME, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"]
# clubSandwich::vcovCR(NEME, cluster = pb.df2weighted$clusterperiod, type = "CR2")["intervention","intervention"]
clubSandwich::vcovCR(NEME, cluster = pb.df2weighted$cluster, type = "CR3")["intervention","intervention"]
clubSandwich::coef_test(NEME, vcov = "CR2",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,]
clubSandwich::coef_test(NEME, vcov = "CR3",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,]

# NEMEw
NEMEw <- mix(outcome ~ intervention + time-1 + (1|cluster) + (1|cluster:period), data=pb.df2weighted, weights=c("W1", "W1", "W1"))
summary(NEMEw)$coef[,"Estimate"]["intervention"]
summary(NEMEw)$coef[,"Std. Error"]["intervention"]^2
NEMEw$SE
# clubSandwich::vcovCR(NEMEw, cluster = pb.df2weighted$cluster, type = "CR2")["intervention","intervention"]
# clubSandwich::vcovCR(NEMEw, cluster = pb.df2weighted$clusterperiod, type = "CR2")["intervention","intervention"]
# clubSandwich::coef_test(NEMEw, vcov = "CR2",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,]
# clubSandwich::coef_test(NEMEw, vcov = "CR3",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,]

```

```{r Test CR3 Jackknife}
library(dplyr)

# https://cran.r-project.org/web/packages/clubSandwich/clubSandwich.pdf
# "CR3" approximates the leave-one-cluster-out jackknife variance estimator (Bell & McCaffrey, 2002).
# # Jackknife text: (Bell & McCaffrey, 2002) https://www150.statcan.gc.ca/n1/en/pub/12-001-x/2002002/article/9058-eng.pdf?st=LqQdp_Ak
# # Jackknife text: https://arxiv.org/pdf/1606.00497.pdf

# IEE <- lm(outcome ~ intervention + time-1, data = pb.df2weighted)
# IEEw <- lm(outcome ~ intervention + time-1, data = pb.df2weighted, weights = pb.df2weighted$W1)
# FE <- lm(outcome ~ intervention + time-1 + cluster, data = pb.df2weighted)
EME <- lme4::lmer(outcome ~ intervention + time-1 + (1|cluster), data = pb.df2weighted)

jk.estimates <- c()
for(i in levels(pb.df2weighted$cluster)){
  jk.dat <- pb.df2weighted %>% filter(cluster!=i)
  jk.estimates <- c(jk.estimates, 
                    # summary(lm(outcome ~ intervention + time-1, data = jk.dat))$coef[,"Estimate"]["intervention"]
                    # summary(lm(outcome ~ intervention + time-1, data = jk.dat, weights = jk.dat$W1))$coef[,"Estimate"]["intervention"]
                    # summary(lm(outcome ~ intervention + time-1 + cluster, data = jk.dat))$coef[,"Estimate"]["intervention"]
                    summary(lme4::lmer(outcome ~ intervention + time-1 + (1|cluster), data = jk.dat)
)$coef[,"Estimate"]["intervention"]
                    
  )
}
jk.estimates
mean(jk.estimates)

# IEE.estimate <- summary(IEE)$coef[,"Estimate"]["intervention"]
# IEEw.estimate <- summary(IEEw)$coef[,"Estimate"]["intervention"]
# FE.estimate <- summary(FE)$coef[,"Estimate"]["intervention"]
EME.estimate <- summary(EME)$coef[,"Estimate"]["intervention"]

# Bell & McCaffrey uses the non-jackknife estimates

# IEE
sum((jk.estimates-IEE.estimate)^2)*(length(jk.estimates)-1)/(length(jk.estimates))
sum((jk.estimates-IEE.estimate)^2) # why don't they account for the differences?
clubSandwich::vcovCR(IEE, cluster = pb.df2weighted$cluster, type = "CR3")["intervention","intervention"]
# coef_test
clubSandwich::coef_test(IEE, vcov = "CR3",  cluster = pb.df2weighted$cluster, test = "naive-t")[1,"SE"]
clubSandwich::coef_test(IEE, vcov = "CR3",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,"SE"]
sqrt(clubSandwich::vcovCR(IEE, cluster = pb.df2weighted$cluster, type = "CR3")["intervention","intervention"])
sqrt(sum((jk.estimates-IEE.estimate)^2))
# doesn't seem to exactly work as expected from the provided formula, as expected

# IEEw
sum((jk.estimates-IEEw.estimate)^2)*(length(jk.estimates)-1)/(length(jk.estimates))
sum((jk.estimates-IEEw.estimate)^2) # why don't they account for the differences?
clubSandwich::vcovCR(IEEw, cluster = pb.df2weighted$cluster, type = "CR3")["intervention","intervention"]
# coef_test
clubSandwich::coef_test(IEEw, vcov = "CR3",  cluster = pb.df2weighted$cluster, test = "naive-t")[1,"SE"]
clubSandwich::coef_test(IEEw, vcov = "CR3",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,"SE"]
sqrt(clubSandwich::vcovCR(IEEw, cluster = pb.df2weighted$cluster, type = "CR3")["intervention","intervention"])
sqrt(sum((jk.estimates-IEEw.estimate)^2))

# FE
sum((jk.estimates-FE.estimate)^2)*(length(jk.estimates)-1)/(length(jk.estimates))
sum((jk.estimates-FE.estimate)^2) # why don't they account for the differences?
clubSandwich::vcovCR(FE, cluster = pb.df2weighted$cluster, type = "CR3")["intervention","intervention"]
# coef_test
clubSandwich::coef_test(FE, vcov = "CR3",  cluster = pb.df2weighted$cluster, test = "naive-t")[1,"SE"]
clubSandwich::coef_test(FE, vcov = "CR3",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,"SE"]
sqrt(clubSandwich::vcovCR(FE, cluster = pb.df2weighted$cluster, type = "CR3")["intervention","intervention"])
sqrt(sum((jk.estimates-FE.estimate)^2))
# package doesn't work for FE at all...

# EME
sum((jk.estimates-EME.estimate)^2)*(length(jk.estimates)-1)/(length(jk.estimates))
sum((jk.estimates-EME.estimate)^2) # why don't they account for the differences?
clubSandwich::vcovCR(EME, cluster = pb.df2weighted$cluster, type = "CR3")["intervention","intervention"]
# coef_test
clubSandwich::coef_test(EME, vcov = "CR3",  cluster = pb.df2weighted$cluster, test = "naive-t")[1,"SE"]
clubSandwich::coef_test(EME, vcov = "CR3",  cluster = pb.df2weighted$cluster, test = "Satterthwaite")[1,"SE"]
sqrt(clubSandwich::vcovCR(EME, cluster = pb.df2weighted$cluster, type = "CR3")["intervention","intervention"])
sqrt(sum((jk.estimates-EME.estimate)^2))
# output results are different for EME
```

